# SSIM Loss 开发日志

> 项目: MedQ-UNI (Uni-MedVL)
> 时间: 2026-02-05 ~ 2026-02-06
> 开发者: Claude Code + 用户协作

---

## 日志总览

| 阶段 | 内容 | 状态 |
|------|------|------|
| Day 1 上午 | 需求分析 + 方案设计 | Done |
| Day 1 下午 | 代码实现 (losses.py, bagel.py, training script) | Done |
| Day 1 下午 | 语法检查 + 新建 SSIM-only 训练脚本 | Done |
| Day 1 晚上 | 首次运行 → TypeError crash | Done |
| Day 1 晚上 | Bug 定位 + 修复 (VAE 集成条件) | Done |
| Day 2 凌晨 | 技术文档编写 | Done |
| Day 2 下午 | v2 修复: 梯度缩放 + Timestep 收紧 | Done |
| Day 2 晚上 | v2 推理崩溃排查 → 发现真正根因 | Done |
| Day 2 晚上 | v3 修复: 模型加载 + 保守参数 | Done |

---

## 2026-02-05

### [需求] SSIM Loss 集成

**背景**: 现有框架已有 CE loss (语言), MSE loss (latent), Pixel loss (L1/L2 像素空间). 用户希望增加 SSIM loss 作为 pixel loss 的替代, 提升医学图像超分/编辑的感知质量.

**设计目标**:
- 模块化: 独立函数, 不影响现有 loss
- 灵活配置: pixel only / SSIM only / 混合使用
- 复用现有架构: timestep 门控, 分块 VAE decode, 安全检查

### [实现] 四个文件的改动

#### 1. `modeling/bagel/losses.py` — 新增 ~200 行

新增四个函数:
```
_gaussian_window()        → 2D 高斯窗口
_ssim_core()              → SSIM 核心公式 (conv2d 实现)
compute_ssim_loss()       → 1 - SSIM loss (支持 mask)
compute_perceptual_loss() → 框架入口 (velocity→z0→VAE decode→SSIM)
```

`compute_perceptual_loss()` 结构与 `compute_pixel_loss()` 平行:
- 相同的 velocity 反推逻辑
- 相同的 timestep 门控
- 相同的分块 VAE decode
- 不同的最终比较方式: SSIM 替代 L1/L2

#### 2. `modeling/bagel/bagel.py` — forward() 新增调用

```python
# pixel loss 之后, 独立调用
ssim = compute_perceptual_loss(...)

# 返回值新增 ssim 字段
return dict(mse=mse, ce=ce, pixel=pixel, ssim=ssim)
```

#### 3. `train/main_sr_pixel_loss.py` — TrainingArguments + 训练循环

新增参数:
```python
ssim_loss_weight: float = 0.0
ssim_loss_max_t: float = 0.3
ssim_window_size: int = 11
```

训练循环: `loss += ssim * ssim_loss_weight`

#### 4. 新建脚本: `scripts/training/train_sft_stage1_medq_unif_multinode_eyeQ1_sr_ssim_loss.sh`

SSIM-only 配置:
```bash
PIXEL_LOSS_WEIGHT=0       # 关闭
SSIM_LOSS_WEIGHT=1.0      # 开启
SSIM_LOSS_MAX_T=0.3
SSIM_WINDOW_SIZE=11
```

### [验证] 语法检查通过

```bash
python3 -c "import ast; ast.parse(open('modeling/bagel/losses.py').read())"    # OK
python3 -c "import ast; ast.parse(open('modeling/bagel/bagel.py').read())"     # OK
python3 -c "import ast; ast.parse(open('train/main_sr_pixel_loss.py').read())" # OK
```

过程中修复了一个语法错误: `compute_perceptual_loss()` 参数顺序问题 (required arg after default arg).

---

### [运行] 首次训练 → Crash

**环境**: H200 × 4 GPUs, 单节点

**报错**:
```
[rank3] File "losses.py", line 1234, in compute_perceptual_loss
[rank3]     x_pred_chunk = x_pred_chunk[:, :, :max_h_img, :max_w_img]
[rank3] TypeError: 'NoneType' object is not subscriptable
```

**排查过程**:
1. `x_pred_chunk` 来自 `vae_decode_fn(latent_chunk)`, 返回了 `None`
2. `vae_decode_fn` 是 `self.vae_decode`, 当 `self.vae_model is None` 时返回 `None`
3. 追溯到模型构建逻辑 (`main_sr_pixel_loss.py:832`):

```python
# 问题代码: 只检查 pixel_loss_weight
if training_args.visual_gen and (
    not training_args.freeze_vae or training_args.pixel_loss_weight > 0
):
    model = Bagel(..., vae_model=vae_model)   # VAE 集成
else:
    model = Bagel(..., vae_model=None)         # VAE 不集成 ← 走了这条路!
```

**根因**: SSIM-only 配置下 `freeze_vae=True` + `pixel_loss_weight=0`, 条件为 `False`, VAE 未集成.

### [修复] 增加 ssim_loss_weight 检查

```python
# 修复后
if training_args.visual_gen and (
    not training_args.freeze_vae
    or training_args.pixel_loss_weight > 0
    or training_args.ssim_loss_weight > 0    # ← 新增
):
```

**修改文件**: `train/main_sr_pixel_loss.py` 第 832 行, 一行改动.

---

## 2026-02-06

### [文档] 技术文档编写

创建 `conversations/20260205_SSIM_Loss_集成技术文档.md`:
- 概述 + 配置模式
- 修改文件清单
- Bug 修复记录
- 参数说明
- SSIM 计算思路详解 (公式 + 对应代码)
- 完整 7 步流程 (velocity → z0 → gate → unpatchify → VAE decode → SSIM → aggregate)
- 架构图

### [文档] 开发日志 (本文件)

---

### [修复] v2: 梯度缩放 + Timestep 收紧

**问题**: v1 SSIM loss 训练后推理坍塌. Loss 曲线正常 (SSIM 有界), 但 SSIM 的有理函数梯度通过 VAE 解码器反传时比 L2 大 200-2000 倍, 腐蚀 LLM/diffusion 权重.

**修复**: 三层梯度衰减

| 参数 | v1 | v2 |
|------|-----|-----|
| `ssim_loss_weight` | 1.0 | 0.1 |
| `ssim_loss_max_t` | 0.3 | 0.1 |
| `ssim_grad_scale` | 无 | 0.1 (新增) |

**改动文件** (4 个):
1. `modeling/bagel/losses.py` — 新增 `_scale_gradient()` + `ssim_grad_scale` 参数
2. `modeling/bagel/bagel.py` — forward() 新增 `ssim_grad_scale`, 默认值更新
3. `train/main_sr_pixel_loss.py` — TrainingArguments 新增 `ssim_grad_scale`
4. `scripts/training/...sr_ssim_loss.sh` — 更新三个参数 + EXP_NAME 改为 `_v2`

**详细文档**: `conversations/20260206_SSIM_Loss_v2_梯度缩放修复方案.md`

---

### [排查] v2 推理崩溃 → 发现真正根因

**问题**: v2 checkpoint (step 4000) 推理时:
- 文本生成: `TypeError: sequence item 600: expected str instance, NoneType found`
- 图像生成: 输出一团糟

**排查过程**:

1. **初步分析**: 怀疑 SSIM 梯度腐蚀 LLM 权重
   - 追溯梯度路径: `LLM → llm2vae → z0 → VAE decode → SSIM`
   - 发现 pixel loss 和 SSIM loss 梯度都传到 LLM backbone (路径完全相同)
   - 分析 per-element 梯度: SSIM 在均匀区域有极端值 (分母 ≈ C2 = 0.0009)

2. **发现参数/注释不一致**: 脚本注释写的 v2 参数 (0.1/0.1) 但实际值是 v1 的 (1/0.3)

3. **真正根因**: `--finetune_from_ema False` 导致模型未正确加载预训练权重, 实际从头训练
   - 4000 步远远不够, 模型根本没训好
   - 不是 SSIM loss 的问题, 是模型加载的问题

**梯度路径分析** (虽非直接根因, 但有参考价值):

| | Pixel Loss (L2) | SSIM Loss |
|---|---|---|
| weight | 10000 | 1 |
| grad_scale | 无 | 0.01 |
| per-element 特性 | 平滑 | 有极端异常值 |

### [修复] v3: 模型加载修复 + 保守 SSIM 参数

**核心修复**: `--finetune_from_ema True` (用户手动)

**保守 SSIM 参数** (防止潜在风险):

| 参数 | v2 实际 | v3 |
|------|---------|-----|
| `SSIM_LOSS_WEIGHT` | 1 | 0.1 |
| `SSIM_LOSS_MAX_T` | 0.3 | 0.1 |
| `SSIM_GRAD_SCALE` | 0.01 | 0.01 |
| `finetune_from_ema` | False | **True** |
| `EXP_NAME` | `..._v2` | `..._v3` |

**详细文档**: `conversations/20260206_SSIM_Loss_v3_推理崩溃排查与修复.md`

---

## 文件变更清单

| 文件 | 变更类型 | 改动行数 |
|------|----------|---------|
| `modeling/bagel/losses.py` | 新增函数 (v1) + 梯度缩放 (v2) | +200 (v1), +15 (v2) |
| `modeling/bagel/bagel.py` | forward() 扩展 (v1) + 参数更新 (v2) | +30 (v1), +3 (v2) |
| `train/main_sr_pixel_loss.py` | TrainingArgs + 训练循环 + VAE 条件修复 (v1) + grad_scale (v2) | +40 (v1), +10 (v2) |
| `scripts/training/...sr_ssim_loss.sh` | 新建 (v1) + 参数更新 (v2) | +277 (v1), ~10 (v2) |
| `scripts/training/...large_pixel_weight.sh` | 新增 SSIM 参数 (v1) | +10 |
| `conversations/20260205_SSIM_Loss_集成技术文档.md` | 新建 | 技术文档 (v1) |
| `conversations/20260206_SSIM_Loss_开发日志.md` | 新建 + 更新 | 本文件 |
| `conversations/20260206_SSIM_Loss_v2_梯度缩放修复方案.md` | 新建 | v2 修复方案文档 |
| `conversations/20260206_SSIM_Loss_v3_推理崩溃排查与修复.md` | 新建 | v3 排查与修复文档 |

## 遗留事项

- [x] 修复后重新运行训练, 确认 SSIM loss 正常下降
- [x] ~~观察 SSIM loss 数值范围是否合理~~ → v1 坍塌, v2 模型加载错误
- [ ] ~~v2 训练验证~~ → 跳过, 直接验证 v3
- [ ] v3 训练验证: 确认模型正确加载 + SSIM loss 正常下降
- [ ] v3 推理验证: 4000 步后文本/图像正常
- [ ] v3 长训练 (20000 步) 稳定性验证
- [ ] 对比实验: SSIM (v3) vs Pixel-only, 评估 PSNR/SSIM/FID 指标
- [ ] 可选: 逐步放松 SSIM 参数 (weight→0.2, max_t→0.15)
- [ ] 可选: per-element gradient clamp 作为额外安全层
- [ ] 考虑: pixel + SSIM 混合模式实验
