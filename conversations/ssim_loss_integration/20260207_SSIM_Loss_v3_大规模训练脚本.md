# SSIM Loss v3 大规模训练脚本创建

**Date**: 2026-02-07
**Status**: Ready for launch

## 背景

小规模验证（eyeQ1 数据集）确认 SSIM Loss 对生成质量有提升。现需迁移到大规模数据集上进行正式训练。

## 新脚本

`scripts/training/train_sft_stage1_medq_unif_multinode_sr_ssim_loss_v3.sh`

## 配置来源

| 类别 | 来源脚本 | 说明 |
|------|----------|------|
| 基础设施/数据 | `train_sft_stage1_medq_unif_multinode_sr_pixel_loss_small_max_T_small_pixel_weight.sh` | 大规模训练模板 |
| SSIM Loss 参数 | `train_sft_stage1_medq_unif_multinode_eyeQ1_sr_ssim_loss.sh` | 已验证有效的 SSIM 配置 |

## 关键参数对比

### 从模板继承（大规模训练基础设施）

| 参数 | 值 |
|------|------|
| CONFIG_FILE | `train_stage1_medq_unif_trainonly.yaml`（大数据集） |
| TOTAL_STEPS | 288000 |
| SAVE_EVERY | 5000 |
| NUM_GPUS | 8 |
| LEARNING_RATE | 2.5e-6 |
| EXPECTED_NUM_TOKENS | 13000 |
| MAX_NUM_TOKENS | 14000 |
| MAX_NUM_TOKENS_PER_SAMPLE | 12000 |

### SSIM Loss 配置（从验证版本）

| 参数 | 值 | 说明 |
|------|------|------|
| PIXEL_LOSS_WEIGHT | **0** | 禁用 pixel loss |
| PIXEL_LOSS_MAX_T | **0.0** | 禁用 pixel loss |
| SSIM_LOSS_WEIGHT | **0.1** | SSIM 权重（从 1.0 降 10x 防梯度爆炸） |
| SSIM_LOSS_MAX_T | **0.1** | 仅在 t≤0.1 时计算（90% 信号，10% 噪声） |
| SSIM_WINDOW_SIZE | **11** | 高斯窗口大小 |
| SSIM_GRAD_SCALE | **0.01** | VAE decoder 梯度缩放 |
| finetune_from_ema | **True** | 从 EMA 权重开始微调 |

### 相比模板移除的参数

pixel loss 的 chunked VAE decode 配置已移除（SSIM 使用自己的 VAE decode 路径）：
- `--pixel_loss_chunk_size`
- `--pixel_loss_adaptive_chunk`
- `--pixel_loss_use_v0`

## 实验名称

`stage1_medq_2nodes_unif_sr_ssim_loss_v3`

## Checkpoint 输出路径

```
/mnt/shared-storage-user/safevl-share/quwanying/MedQbench/MedQ-UNI/model_checkpoints/training_stage1/stage1_medq_2nodes_unif_sr_ssim_loss_v3/
```

## 注意事项

1. Pixel loss 完全关闭（weight=0, max_t=0.0），仅由 SSIM 提供像素空间监督
2. SSIM 三层衰减机制防止梯度爆炸：weight 0.1 + max_t 0.1 + grad_scale 0.01
3. 已包含 dtype mismatch 修复（见 `20260207_SSIM_Loss_v4_dtype_mismatch_fix.md`）
